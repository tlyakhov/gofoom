// Copyright (c) Tim Lyakhovetskiy
// SPDX-License-Identifier: MPL-2.0

package properties

import (
	"reflect"

	"tlyakhov/gofoom/editor/state"

	"fyne.io/fyne/v2/widget"
)

func checkFlag(flags reflect.Value, test reflect.Value) bool {
	if flags.CanInt() {
		return flags.Int()&test.Int() != 0
	} else if flags.CanUint() {
		return flags.Uint()&test.Uint() != 0
	}
	return false
}

func (g *Grid) fieldEnum(field *state.PropertyGridField, enumValues any) {
	// This is the actual value of this property converted to an int.
	origValue := field.Values[0].Deref()
	// TODO: If we're dealing with ComponentFlags, hide the internal stuff
	isFlags := field.EditType == "Flags"

	selectedIndex := 0
	selectedOpts := make([]string, 0)
	opts := make([]string, 0)
	optsValues := make([]reflect.Value, 0)
	optsMap := make(map[string]reflect.Value)
	// Iterate through all the values of the enum type.
	refEnumValues := reflect.ValueOf(enumValues)
	for i := range refEnumValues.Len() {
		enumValue := refEnumValues.Index(i)
		// Our enum should have a String() method generated by the enumer library. Call it.
		enumName := enumValue.MethodByName("String").Call([]reflect.Value{})[0].String()
		// Set the GTK+ list entry.
		opts = append(opts, enumName)
		optsValues = append(optsValues, enumValue)
		optsMap[enumName] = enumValue
		if !isFlags && enumValue.Equal(origValue) {
			selectedIndex = i
		} else if isFlags && checkFlag(enumValue, origValue) {
			selectedOpts = append(selectedOpts, enumName)
		}
	}

	if isFlags {
		checkGroup := gridAddOrUpdateWidgetAtIndex[*widget.CheckGroup](g)
		checkGroup.Options = opts
		checkGroup.OnChanged = nil
		if field.Disabled() {
			checkGroup.Disable()
		} else {
			checkGroup.Enable()
		}
		checkGroup.SetSelected(selectedOpts)
		checkGroup.OnChanged = func(s []string) {
			flags := uint64(0)
			for _, v := range s {
				flags = flags | optsMap[v].Convert(reflect.TypeFor[uint64]()).Uint()
			}
			g.ApplySetPropertyAction(field, reflect.ValueOf(flags).Convert(field.Type.Elem()))
		}
	} else {
		selectEntry := gridAddOrUpdateWidgetAtIndex[*widget.Select](g)
		selectEntry.Options = opts
		selectEntry.OnChanged = nil
		if field.Disabled() {
			selectEntry.Disable()
		} else {
			selectEntry.Enable()
		}
		selectEntry.SetSelectedIndex(selectedIndex)
		selectEntry.OnChanged = func(opt string) {
			g.ApplySetPropertyAction(field, optsValues[selectEntry.SelectedIndex()])
		}
	}
}
